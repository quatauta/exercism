#!/bin/sh

PROJECT_DIR="${CI_PROJECT_DIR}"

if [ -z "${PROJECT_DIR}" ] ; then
  if [ -z "$(command -v git)" ] ; then
    PROJECT_DIR="$(git rev-parse --show-toplevel)"
  else
    for LEVEL_UP in "." ".." "../.." "../../../" ; do
      if [ -r "${LEVEL_UP}/LICENSE" ] ; then
        PROJECT_DIR="${LEVEL_UP}"
        break
      fi
    done
  fi
fi

find "${PROJECT_DIR}/elixir" -mindepth 1 -maxdepth 1 -type d |
sort |
while read -r TESTCASE ; do
  (
    echo "${TESTCASE}"
    cd "${TESTCASE}" &&
    find . -maxdepth 1 -iname "mix.exs" -print0 |
    xargs -0rt -IPROJECT sh -c 'mix credo --format oneline' || exit 1
    echo
  )
done
